# AI Avatar Generation Feature

## 提案背景

在完成项目的基础设施搭建后（前后端框架、数据库模型、UI 组件库），我们需要实现 PetsPhoto 的核心功能：AI 宠物头像生成。这是产品的核心价值所在，也是用户的主要使用场景。

当前状态：
- ✅ 前端项目已初始化（React + TypeScript + Tailwind + shadcn/ui）
- ✅ 后端项目已初始化（FastAPI + SQLAlchemy）
- ✅ 数据库模型已创建（User, UploadedImage, GenerationJob, GenerationStyle 等）
- ✅ 数据库已迁移并填充了种子数据（5 种预设风格，4 个积分套餐）
- ✅ UI 设计系统已实施（主题、布局组件、shadcn/ui 核心组件）

待实现：
- ❌ 图片上传功能（前后端）
- ❌ 风格选择界面
- ❌ Veo3 API 集成和图像生成
- ❌ 生成任务管理和状态跟踪
- ❌ 结果展示和下载功能

## 提案目标

实现完整的 AI 宠物头像生成工作流，从用户上传宠物照片到获得艺术化头像的全过程。

**MVP 范围界定**：
- ✅ 实现图片上传、风格选择、AI 生成、结果展示的完整流程
- ✅ 集成 Veo3 API 进行真实的图像生成
- ✅ 提供良好的用户体验（加载状态、错误处理、成功反馈）
- ✅ 完整的端到端测试

**明确排除**（留待后续提案）：
- ❌ 用户认证和登录系统（Authentik 集成）
- ❌ 支付系统（Stripe 集成）
- ❌ 积分消耗逻辑
- ❌ 生成历史记录和画廊页面
- ❌ 自定义风格描述（文本输入）

为了在没有认证系统的情况下进行开发和测试，我们将：
1. 在后端创建一个临时的"访客用户"（guest user）逻辑
2. 前端跳过登录流程，直接进入生成器页面
3. 临时禁用积分检查，允许无限生成

## 提案范围

### 包含的能力（Capabilities）

1. **image-upload** - 图片上传功能
   - 前端拖拽上传组件
   - 前端图片预览和验证
   - 后端文件接收和存储
   - 图片元数据提取（尺寸、格式、大小）

2. **ai-generation** - AI 图像生成
   - Veo3 API 客户端封装
   - 生成任务创建和管理
   - 异步任务处理（生成状态跟踪）
   - 错误处理和重试逻辑

3. **generation-ui** - 生成器用户界面
   - 风格选择器（展示 5 种预设风格）
   - 生成器页面布局
   - 加载状态和进度指示
   - 结果展示和下载功能

### 架构决策

#### 为什么采用前后端分离架构？
- 前端负责用户交互和状态管理，提供流畅的用户体验
- 后端负责文件处理、API 调用和数据持久化，保证业务逻辑安全
- 通过 RESTful API 通信，便于后续扩展（如移动端 App）

#### 为什么使用异步任务处理？
- AI 图像生成通常需要 10-30 秒，同步调用会导致请求超时
- 异步处理允许前端轮询状态，提供更好的用户反馈
- 为后续引入任务队列（如 Celery）预留架构空间

#### 为什么先实现预设风格而非自定义风格？
- 预设风格降低用户使用门槛，提供开箱即用的体验
- 预设风格有更可控的生成质量
- 自定义风格需要更复杂的 prompt 工程，留待后续迭代

#### 临时访客用户方案
- 在数据库中创建一个固定的 `guest` 用户（在 seed data 中）
- 所有未登录的请求都关联到这个用户
- 后续引入认证后，迁移访客数据或清理测试数据

### 技术选型

- **文件上传**：使用 FastAPI 的 `UploadFile`，配合前端 FormData
- **图片存储**：初期使用本地文件系统（`backend/uploads/` 目录）
- **AI API**：Veo3 API（需要 API key）
- **状态管理**：前端使用 TanStack Query (React Query) 进行服务器状态管理
- **轮询机制**：前端使用 polling 定期检查生成任务状态

### 用户流程

```
1. 用户访问生成器页面 → 看到上传区域和风格选择器
2. 用户拖拽或选择宠物照片 → 前端验证并预览
3. 用户选择一种艺术风格 → 视觉反馈（选中状态）
4. 用户点击"生成"按钮 → 发送请求到后端
5. 后端创建生成任务 → 返回任务 ID
6. 前端开始轮询任务状态 → 显示加载动画
7. 后端调用 Veo3 API → 生成图像
8. 生成完成后更新任务状态 → 保存结果 URL
9. 前端检测到完成 → 展示生成的图像
10. 用户可以下载图像或重新生成
```

### 成功标准

1. **功能完整性**：
   - ✅ 用户可以成功上传图片（支持拖拽和点击）
   - ✅ 用户可以选择 5 种预设风格之一
   - ✅ 点击生成后，能成功调用 Veo3 API 并获得结果
   - ✅ 生成结果正确显示，可以下载

2. **用户体验**：
   - ✅ 上传过程有清晰的视觉反馈（预览、进度）
   - ✅ 生成过程有加载指示（骨架屏或进度条）
   - ✅ 错误情况有友好的提示（Toast 通知）
   - ✅ 移动端和桌面端都有良好的响应式体验

3. **技术质量**：
   - ✅ 代码遵循项目规范（TypeScript 类型安全、Python 类型注解）
   - ✅ 关键功能有单元测试（文件上传、API 调用）
   - ✅ API 端点有错误处理和验证
   - ✅ 图片文件有大小和格式验证

4. **测试验证**：
   - ✅ 端到端测试：完整走通上传→选择风格→生成→下载流程
   - ✅ 错误场景测试：无效图片、API 失败、网络错误等
   - ✅ 边界测试：最大文件大小、不支持的格式等

## 不包含的内容

- 用户认证和授权（所有请求暂时使用访客用户）
- 积分系统和支付流程（生成暂时免费）
- 生成历史记录页面（只关注单次生成流程）
- 自定义风格文本输入
- 图片编辑功能（裁剪、旋转等）
- 社交分享功能
- 图片云存储（使用本地存储）

## 后续迭代方向

1. **Phase 2: 用户系统**
   - Authentik 集成
   - 登录/注册页面
   - 用户 profile 管理

2. **Phase 3: 支付系统**
   - Stripe 集成
   - 积分购买流程
   - 生成消耗积分

3. **Phase 4: 功能增强**
   - 自定义风格描述
   - 生成历史画廊
   - 批量生成
   - 图片编辑工具

## 风险和缓解措施

### 技术风险

1. **Veo3 API 不稳定或限流**
   - 缓解：实现重试逻辑和错误处理
   - 备选：准备即梦 API 作为后备方案

2. **大文件上传性能问题**
   - 缓解：前端限制文件大小（10MB）
   - 优化：后续可以添加图片压缩

3. **生成时间过长导致用户流失**
   - 缓解：提供清晰的进度指示
   - 优化：考虑估算剩余时间

### 业务风险

1. **无认证导致滥用**
   - 缓解：添加 rate limiting（每 IP 限制请求频率）
   - 临时方案：开发环境仅供测试使用

2. **生成成本过高**
   - 缓解：使用 Veo3 测试 API 或低成本模型
   - 监控：记录每次生成的成本

## 时间估算

- **image-upload**: 1-2 天
  - 前端上传组件：0.5 天
  - 后端文件处理：0.5 天
  - 测试和优化：0.5 天

- **ai-generation**: 2-3 天
  - Veo3 API 集成：1 天
  - 异步任务管理：1 天
  - 测试和错误处理：1 天

- **generation-ui**: 1-2 天
  - 风格选择器：0.5 天
  - 生成器页面布局：0.5 天
  - 结果展示和下载：0.5 天
  - 轮询和状态管理：0.5 天

**总计**: 4-7 天（单人开发）

## 依赖项

### 外部依赖
- Veo3 API key（需要提前申请）
- 稳定的网络环境（API 调用）

### 内部依赖
- 数据库模型已创建 ✅
- shadcn/ui 组件已安装 ✅
- 前后端项目已初始化 ✅

### 环境要求
- Python 3.10+ 环境
- Node.js 18+ 环境
- 足够的磁盘空间（存储上传的图片和生成结果）
